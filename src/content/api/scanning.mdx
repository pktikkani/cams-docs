# Scanning & Validation API

## Validate QR Code

This is the core endpoint used by scanner apps to validate contractor QR codes.

```
POST /api/v1/scanner/validate
```

### Headers
```
Authorization: Bearer <guard-token>
```

### Request Body

```json
{
  "qr_data": "eyJjb250cmFjdG9yX2lkIjoi...",
  "scanner_site_code": "NAMA-HQ-001",
  "scan_mode": "entry"
}
```

| Field | Type | Description |
|-------|------|-------------|
| `qr_data` | string | Base64-encoded QR payload |
| `scanner_site_code` | string | Site code of the scanning device |
| `scan_mode` | string | `"entry"` or `"exit"` |

### Access Granted Response (200)

```json
{
  "status": "granted",
  "contractor": {
    "name": "John Doe",
    "company": "Acme Corp",
    "email": "john.doe@contractor.com",
    "photo_url": "https://..."
  }
}
```

### Access Denied Response (200)

```json
{
  "status": "denied",
  "reason": "No active schedule found for this site"
}
```

## Get Available Sites

```
GET /api/v1/scanner/sites
```

### Headers
```
Authorization: Bearer <guard-token>
```

### Response (200)

```json
{
  "status": "success",
  "data": [
    {
      "id": "uuid",
      "site_code": "NAMA-HQ-001",
      "site_name": "NAMA Headquarters",
      "is_active": true
    }
  ]
}
```

## Assign Site

```
POST /api/v1/scanner/assign-site
```

### Headers
```
Authorization: Bearer <guard-token>
```

### Request Body

```json
{
  "site_id": "uuid"
}
```

### Response (200)

```json
{
  "status": "success",
  "data": {
    "assigned_site": {
      "id": "uuid",
      "site_code": "NAMA-HQ-001",
      "site_name": "NAMA Headquarters"
    }
  }
}
```

## Get Assigned Site

```
GET /api/v1/scanner/assigned-site
```

### Headers
```
Authorization: Bearer <guard-token>
```

### Response (200)

```json
{
  "status": "success",
  "data": {
    "id": "uuid",
    "site_code": "NAMA-HQ-001",
    "site_name": "NAMA Headquarters"
  }
}
```

## Get Offline Bundle

Downloads a pre-built bundle containing contractor data, TOTP seeds, and site schedules for offline QR validation. Used by the scanner app before going offline.

```
GET /api/v1/scanner/offline-bundle
```

### Headers
```
Authorization: Bearer <guard-token>
```

### Response (200)

```json
{
  "status": "success",
  "data": {
    "bundle_version": "2026-02-13T10:00:00Z",
    "contractors": [
      {
        "id": "uuid",
        "full_name": "John Doe",
        "company": "Acme Corp",
        "totp_seed": "JBSWY3DPEHPK3PXP",
        "photo_url": "https://...",
        "is_active": true
      }
    ],
    "schedules": [
      {
        "contractor_id": "uuid",
        "site_id": "uuid",
        "start_date": "2026-01-01",
        "end_date": "2026-12-31",
        "allowed_days": ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday"],
        "start_time": "07:00",
        "end_time": "17:00"
      }
    ],
    "site": {
      "id": "uuid",
      "site_code": "NAMA-HQ-001",
      "site_name": "NAMA Headquarters",
      "geofence_radius": 200
    }
  }
}
```

The bundle is scoped to the guard's currently assigned site. The iOS scanner app encrypts this bundle with AES-GCM before storing locally.

## Sync Offline Scans

Uploads scan logs that were recorded while the scanner was offline. The server deduplicates by nonce.

```
POST /api/v1/scanner/sync-scans
```

### Headers
```
Authorization: Bearer <guard-token>
```

### Request Body

```json
{
  "scans": [
    {
      "contractor_id": "uuid",
      "site_id": "uuid",
      "scan_mode": "entry",
      "scan_result": "granted",
      "scanned_at": "2026-02-13T08:15:00Z",
      "nonce": "abc123def456"
    }
  ]
}
```

### Response (200)

```json
{
  "status": "success",
  "data": {
    "synced": 5,
    "duplicates": 1
  }
}
```
