# Authentication API

## Contractor Login

```
POST /api/v1/auth/login
```

### Request Body

```json
{
  "email": "john.doe@contractor.com",
  "password": "password123",
  "device_fingerprint": "a9f9b6a24496889ba0b6aac5dd7092ff4a633fd142b6da0da494ecf8ae70185b"
}
```

### Success Response (200)

```json
{
  "status": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "contractor": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "full_name": "John Doe",
      "email": "john.doe@contractor.com",
      "company": "Acme Corp",
      "totp_seed": "JBSWY3DPEHPK3PXP",
      "photo_url": "https://...",
      "is_active": true
    }
  }
}
```

### Error Response (401)

```json
{
  "status": "error",
  "message": "Invalid credentials"
}
```

## Guard Login

```
POST /api/v1/scanner/login
```

### Request Body

```json
{
  "email": "guard@security.com",
  "password": "guardpass123",
  "device_fingerprint": "7617b0afd25ba04d6b3f2fdc19050ddd83889f243584367426e6df679d222784"
}
```

### Success Response (200)

```json
{
  "status": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "guard": {
      "id": "uuid",
      "name": "Security Guard",
      "assigned_site": {
        "id": "uuid",
        "site_code": "NAMA-HQ-001",
        "site_name": "NAMA Headquarters"
      }
    }
  }
}
```

## Admin Login

```
POST /api/v1/admin/login
```

### Request Body

```json
{
  "email": "admin@cams.com",
  "password": "password123"
}
```

### Success Response (200)

```json
{
  "status": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIs...",
    "user": {
      "id": "uuid",
      "email": "admin@cams.com",
      "name": "Super Admin",
      "role": "super_admin"
    }
  }
}
```

See [Admin Endpoints](/docs/api/admin) for the full admin API.

## HMAC Request Signing

Contractor and scanner endpoints require HMAC-SHA256 request signing in addition to JWT. Two headers must be present:

| Header | Description |
|--------|-------------|
| `X-Timestamp` | Unix timestamp (seconds). Must be within 5 minutes of server time. |
| `X-Signature` | HMAC-SHA256 of `timestamp.body` using the per-device HMAC key. |

Each device receives a unique 256-bit HMAC key on login (returned in the `hmac_key` field of the login response). The backend resolves the correct key from the JWT identity — there is no shared secret.

Requests missing or failing HMAC verification return `401 Unauthorized`.

Admin endpoints do **not** require HMAC — only JWT authentication.

## Device Fingerprint Validation

All login endpoints validate the `device_fingerprint` field:

- Must be a valid **SHA-256 hex string** (exactly 64 hexadecimal characters)
- Invalid format returns `400` with `invalid_device_fingerprint` error
- Empty fingerprint returns `400` with `missing_fields` error

## JWT Token Claims

All JWT tokens include standardized claims for security:

| Claim | Value | Purpose |
|-------|-------|---------|
| `iss` | `cams-api` | Issuer validation |
| `sub` | User UUID | Subject identification |
| `aud` | `contractor` / `scanner` / `admin` | Token type isolation |

Using an admin JWT on a scanner endpoint (or vice versa) will be rejected with `401 Unauthorized`.
