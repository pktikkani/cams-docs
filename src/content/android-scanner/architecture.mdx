# App Architecture (Android Scanner)

## Project Structure

```
com.pragmatic.contractorqrscanner/
â”œâ”€â”€ MainActivity.kt                    # Entry point with navigation
â”œâ”€â”€ ContractorQRScannerApp.kt         # Application class
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ LanguageManager.kt            # Multi-language support
â”‚   â”œâ”€â”€ network/
â”‚   â”‚   â”œâ”€â”€ AppUpdateChecker.kt       # Version checking
â”‚   â”‚   â””â”€â”€ NetworkMonitor.kt         # Connectivity monitoring
â”‚   â””â”€â”€ notifications/
â”‚       â””â”€â”€ PushNotificationManager.kt
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ SessionManager.kt             # Auth token + guard info
â”‚   â”œâ”€â”€ ScanHistoryManager.kt         # Local scan audit log
â”‚   â”œâ”€â”€ OfflineValidationCache.kt     # Offline validation data
â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â””â”€â”€ Models.kt                 # Data classes
â”‚   â””â”€â”€ network/
â”‚       â”œâ”€â”€ ApiService.kt             # Retrofit interface
â”‚       â””â”€â”€ ApiClient.kt              # Retrofit + OkHttp config
â””â”€â”€ ui/
    â”œâ”€â”€ auth/
    â”‚   â”œâ”€â”€ LoginScreen.kt
    â”‚   â””â”€â”€ SiteSelectionScreen.kt
    â”œâ”€â”€ scanner/
    â”‚   â”œâ”€â”€ ScannerScreen.kt          # Main scanning UI
    â”‚   â”œâ”€â”€ ScannerViewModel.kt       # Scan logic + validation
    â”‚   â”œâ”€â”€ CameraPreview.kt          # CameraX + ML Kit
    â”‚   â”œâ”€â”€ ScannerOverlay.kt         # Visual scan frame
    â”‚   â””â”€â”€ ResultViews.kt            # Granted/Denied/Error views
    â”œâ”€â”€ history/
    â”‚   â””â”€â”€ HistoryScreen.kt          # Scan log viewer
    â”œâ”€â”€ components/
    â”‚   â””â”€â”€ DetailRow.kt
    â””â”€â”€ theme/                        # Colors, typography, theme
```

## Architecture Pattern

**MVVM** with StateFlow:

```mermaid
graph TD
    UI[ğŸ–¥ï¸ ScannerScreen<br/>Jetpack Compose] <-->|observes StateFlow| VM[ğŸ§  ScannerViewModel<br/>Business Logic]
    VM <-->|calls| API[ğŸŒ ApiService<br/>Retrofit + OkHttp]
    API <-->|HTTPS| BE[âš™ï¸ Backend API]

    style UI fill:#06b6d4,color:#fff
    style VM fill:#f59e0b,color:#fff
    style API fill:#10b981,color:#fff
    style BE fill:#3b82f6,color:#fff
```

## State Machine

```mermaid
stateDiagram-v2
    [*] --> Scanning
    Scanning --> Validating : QR detected
    Validating --> Result : API response
    Validating --> Error : Network/parse error
    Result --> Scanning : 8s auto-reset
    Error --> Scanning : 5s auto-reset
```

### Timing Constants

| Parameter | Value |
|-----------|-------|
| Scan debounce | 2,000 ms |
| Result auto-reset | 8,000 ms |
| Error auto-reset | 5,000 ms |
| Offline cache validity | 48 hours |
| Max scan history | 500 entries |
| Max offline cache | 200 entries |

## Camera Pipeline

```mermaid
flowchart TD
    A[CameraX Provider] --> B[Preview Use Case<br/>â†’ SurfaceView]
    A --> C[ImageAnalysis Use Case<br/>â†’ ML Kit BarcodeScanner]
    C --> D{QR Detected?}
    D -->|No| C
    D -->|Yes| E[Extract Value]
    E --> F{Debounce<br/>2s cooldown?}
    F -->|Too soon| C
    F -->|OK| G[ScannerViewModel.onQRScanned]
    G --> H[POST /api/v1/scanner/validate]
    H --> I[Update ScanUiState]
    I --> J[UI Recomposition]
    J -->|8s auto-reset| C

    style D fill:#f59e0b,color:#fff
    style H fill:#3b82f6,color:#fff
    style I fill:#22c55e,color:#fff
```

## Permissions

| Permission | Purpose |
|------------|---------|
| `CAMERA` | QR code scanning |
| `INTERNET` | API communication |
| `POST_NOTIFICATIONS` | Push notifications |

## Data Persistence

| Data | Storage | Format |
|------|---------|--------|
| Auth token | SharedPreferences | String |
| Guard info | SharedPreferences | JSON (Gson) |
| Scan history | SharedPreferences | JSON array (Gson) |
| Offline cache | SharedPreferences | JSON map (Gson) |
| Language pref | SharedPreferences | String |
