# System Architecture

CAMS follows a client-server architecture with multiple mobile clients connecting to a centralized Go backend, all managed through a Next.js admin portal.

## High-Level Architecture

```mermaid
graph TD
    CA["ðŸ“± Contractor App â€” iOS / Android"] -->|HTTPS REST API| BE
    SA["ðŸ“· Scanner App â€” iOS / Android"] -->|HTTPS REST API| BE

    BE["âš™ï¸ Go Backend - Fiber"]

    subgraph Backend_Services["Backend Services"]
        direction LR
        AUTH[Auth] --- VALIDATE[Validate] --- DEVICES[Devices]
        TOTP[TOTP] --- GEOFENCE[Geofence] --- LOGGING[Logging]
    end

    BE --> Backend_Services
    BE -->|SQL| DB[("ðŸ˜ PostgreSQL â€” Railway")]
    BE -->|Nonce/Cache| RD[(Redis)]
    AP["ðŸ–¥ï¸ Admin Portal â€” Next.js 16"] -->|SQL| DB

    subgraph Observability_Stack["Observability"]
        direction LR
        PROM[Prometheus] --- GRAF[Grafana]
        LOKI[Loki] --- GRAF
    end

    BE -->|/metrics| PROM
    BE -->|JSON logs| LOKI

    style CA fill:#06b6d4,color:#fff
    style SA fill:#06b6d4,color:#fff
    style BE fill:#f59e0b,color:#fff
    style DB fill:#3b82f6,color:#fff
    style RD fill:#dc2626,color:#fff
    style AP fill:#10b981,color:#fff
    style PROM fill:#e6522c,color:#fff
    style GRAF fill:#f46800,color:#fff
    style LOKI fill:#2c3e50,color:#fff
```

## Technology Stack

### Backend
- **Language**: Go 1.24+
- **Framework**: Fiber v2 (high-performance HTTP framework)
- **Database**: PostgreSQL 16+ (hosted on Railway)
- **Cache**: Redis 7 (nonce anti-replay, session cache)
- **Auth**: JWT tokens with `golang-jwt/jwt/v5`
- **TOTP**: `pquerna/otp` library (RFC 6238 compliant)
- **Hashing**: bcrypt (cost 14) for passwords
- **Logging**: zerolog (structured JSON to stdout + Loki)
- **Metrics**: Prometheus client (`client_golang`)
- **Monitoring**: Grafana dashboards + alerting

### Mobile Apps
| Feature | Android | iOS |
|---------|---------|-----|
| Language | Kotlin | Swift |
| UI Framework | Jetpack Compose | SwiftUI |
| Networking | Retrofit + OkHttp | URLSession |
| QR Generation | ZXing | CoreImage CIFilter |
| QR Scanning | CameraX + ML Kit | AVFoundation |
| Location | Google Play Services | CoreLocation |
| Biometrics | AndroidX Biometric | LocalAuthentication |
| Storage | EncryptedSharedPreferences | Keychain |

### Admin Portal
- **Framework**: Next.js 16 (App Router)
- **Language**: TypeScript
- **API Layer**: tRPC v11 with SuperJSON
- **Database**: PostgreSQL via `pg` driver (raw SQL)
- **UI**: shadcn/ui + Tailwind CSS
- **Charts**: Recharts
- **Maps**: Leaflet + react-leaflet
- **Auth**: JWT via `jose` + httpOnly cookies
- **Validation**: Zod v4
- **Export**: SheetJS (xlsx)

## Database Schema

### Core Tables

| Table | Purpose |
|-------|---------|
| `contractors` | Contractor profiles with TOTP seeds |
| `sites` | Physical site locations with geofence coordinates |
| `access_schedules` | Time-based access rules per contractor per site |
| `scan_logs` | Audit trail of all QR scans |
| `admin_users` | Portal admin accounts with role-based access |
| `scanner_devices` | Registered scanner tablets (with per-device HMAC keys) |
| `devices` | Contractor device registrations (with per-device HMAC keys) |

### Entity Relationships

```mermaid
erDiagram
    contractors ||--o{ access_schedules : "has"
    contractors ||--o{ devices : "registers"
    contractors ||--o{ scan_logs : "scanned"
    sites ||--o{ access_schedules : "assigned"
    sites ||--o{ scan_logs : "at"
    sites ||--o{ scanner_devices : "deployed"
    scanner_devices ||--o{ scan_logs : "records"

    contractors {
        uuid id PK
        string email
        string first_name
        string last_name
        string totp_seed
        boolean is_active
    }

    sites {
        uuid id PK
        string site_code
        string site_name
        float latitude
        float longitude
        int geofence_radius
    }

    access_schedules {
        uuid id PK
        uuid contractor_id FK
        uuid site_id FK
        date start_date
        date end_date
        array allowed_days
    }

    scan_logs {
        uuid id PK
        uuid contractor_id FK
        uuid site_id FK
        string scan_result
        timestamp scan_timestamp
        string prev_hash
        string log_hash
    }

    admin_users {
        uuid id PK
        string email
        string role
        boolean is_active
    }
```

### Key Relationships
- A contractor can have **multiple access schedules** across different sites
- Each site has a **geofence radius** for location verification
- Scan logs record the **contractor, site, scanner device, timestamp, and result**
- Admin users have **role-based permissions** (super_admin, site_admin, viewer, auditor)

## API Base URL

```
https://contractor-api.nubewired.com
```

All mobile apps and the admin portal connect to this single backend API.
