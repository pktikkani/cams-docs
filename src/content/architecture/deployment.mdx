# Deployment

## Backend API

The Go backend is deployed as a containerized service:

- **Hosting**: Railway (PaaS) â€” production; Docker Compose â€” local/Oman DC
- **URL**: `https://contractor-api.nubewired.com`
- **Database**: PostgreSQL 16 on Railway
- **Cache**: Redis 7 (nonce anti-replay)
- **SSL**: Automatic TLS via Railway
- **Go Version**: 1.24 (Dockerfile: `golang:1.24-alpine`)

## Admin Portal

The Next.js admin portal can be deployed to:

- **Vercel** (recommended for Next.js)
- **Railway** (same platform as backend)
- **Any Node.js hosting** supporting Next.js

### Environment Variables

```bash
# Required
DATABASE_URL=postgresql://user:pass@host:5432/dbname
JWT_SECRET=your-secret-key

# Optional
DB_SSL=true
```

### Build & Deploy

```bash
npm install
npm run build
npm start
```

## Docker Compose (Local / Oman DC)

The full stack runs via `docker compose up -d` with 6 services:

| Service | Image | Port | Purpose |
|---------|-------|------|---------|
| `api` | Built from Dockerfile | 8080 | Go API server |
| `postgres` | `postgres:16-alpine` | 5432 | Primary database |
| `redis` | `redis:7-alpine` | 6379 | Nonce cache / anti-replay |
| `prometheus` | `prom/prometheus:latest` | 9090 | Metrics scraping (15s interval) |
| `loki` | `grafana/loki:3.0.0` | 3100 | Log aggregation (30-day retention) |
| `grafana` | `grafana/grafana:latest` | 3000 | Dashboards + alerting |

### Environment Variables (Docker)

```bash
# API service (required)
JWT_SECRET=your-jwt-secret
DATABASE_URL=postgresql://user:pass@postgres:5432/cams

# API service (optional)
HMAC_SECRET=your-hmac-secret        # Fallback shared key (migration only)
LOKI_URL=http://loki:3100           # Enables structured log push to Loki
CORS_ORIGINS=https://admin.example.com  # Comma-separated allowed origins
METRICS_TOKEN=your-metrics-token    # Bearer token for /metrics endpoint (unset = open)

# Grafana
GF_SECURITY_ADMIN_USER=admin
GF_SECURITY_ADMIN_PASSWORD=admin
```

### Quick Start

```bash
cd contractor-qr-api
docker compose up -d
```

- API: `http://localhost:8080`
- Health: `http://localhost:8080/health` (checks PostgreSQL + Redis connectivity)
- Metrics: `http://localhost:8080/metrics` (protected by `METRICS_TOKEN` if set)
- Prometheus: `http://localhost:9090`
- Grafana: `http://localhost:3000` (admin/admin)
- Loki: `http://localhost:3100`

Grafana is auto-provisioned with datasources (Prometheus + Loki), two dashboards (API Overview + Security), and 6 alert rules.

The API supports **graceful shutdown** â€” on SIGTERM/SIGINT, it drains active connections (10s timeout) before closing database and Redis connections.

## Mobile Apps

### Android
- **Distribution**: Google Play Store or direct APK
- **Min SDK**: API 26 (Android 8.0)
- **Build**: Android Studio + Gradle (Kotlin DSL)

### iOS
- **Distribution**: App Store or TestFlight
- **Min iOS**: 16.0
- **Build**: Xcode 15+

## Database Migrations

Run migrations to set up the database schema:

```bash
npx tsx src/server/db/migrate.ts
```

This creates all required tables:
- `admin_users` with role-based access
- `scanner_devices` with site assignments
- Default super admin user: `admin@cams.com` / `admin123`

## Infrastructure Diagram

```mermaid
graph TB
    subgraph Clients
        IOS[ðŸ“± iOS Apps]
        AND[ðŸ“± Android Apps]
        WEB[ðŸŒ Browser]
    end

    subgraph Application_Layer["Application Layer"]
        AP["ðŸ–¥ï¸ Admin Portal â€” Vercel / Railway"]
        BE["âš™ï¸ Go Backend â€” Railway / Docker"]
    end

    subgraph Data_Layer["Data Layer"]
        DB[("ðŸ˜ PostgreSQL 16")]
        RD[(Redis 7)]
    end

    subgraph Observability_Stack["Observability Stack"]
        PROM["Prometheus :9090"]
        LOKI["Loki :3100"]
        GRAF["Grafana :3000"]
    end

    WEB -->|HTTPS| AP
    AP -->|DATABASE_URL| DB
    BE -->|SQL| DB
    BE -->|Nonce/Cache| RD
    IOS -->|HTTPS REST| BE
    AND -->|HTTPS REST| BE

    BE -->|/metrics| PROM
    BE -->|JSON logs| LOKI
    PROM --> GRAF
    LOKI --> GRAF

    style AP fill:#10b981,color:#fff
    style BE fill:#f59e0b,color:#fff
    style DB fill:#3b82f6,color:#fff
    style RD fill:#dc2626,color:#fff
    style IOS fill:#06b6d4,color:#fff
    style AND fill:#06b6d4,color:#fff
    style WEB fill:#8b5cf6,color:#fff
    style PROM fill:#e6522c,color:#fff
    style LOKI fill:#2c3e50,color:#fff
    style GRAF fill:#f46800,color:#fff
```
